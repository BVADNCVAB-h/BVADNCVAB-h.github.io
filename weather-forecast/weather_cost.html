<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=windows-1251">
<title>Стоимость Погоды</title>
<style type="text/css" media="all">
	body {
		background-color: #fefefe;
		color: #113355;
	}
	#header, #footer {
		text-align: center;
		font-size: 2.1em;
		padding: 20px;
		margin: 6px;
		background-color: #4499cc;
		color: #fefefe;
	}
	#footer {
		transition-property: background-color;
		transition-duration: 200ms;
		transition-delay: 50ms;
	}
	#footer:hover {
		background-color: #113355;
	}
	.tempcost_cell {
		display: inline-block;
		transition-property: background-color;
		transition-duration: 200ms;
		transition-delay: 50ms;
		background-color: #eef5ff;
		border-color: #4499cc;
		color: #113355;
		border-width: 2px;
		border-style: solid;
		margin: 6px;
		padding: 6px;
		text-align: center;
	}
	.tempcost_head {
		display: inline-block;
		margin: 6px;
		color: #113355;
		text-align: center;
		align-self: center;
	}
	.tempcost_cell:hover {
		background-color: #fafcff;
	}
	.tempcost_temp {
		color: #4499cc;
		font-size: 1.4em;
	}
	.tempcost_cost {
		font-size: 1.4em;
	}
	.tempcost_power {
		font-size: 1.4em;
		color: #4499cc;
	}
	.tempcost_rnd_temp {
		font-size: 1.8em;
	}
	.tempcost_table {
		display: grid;
		grid-template-rows: 16fr;
		grid-template-columns: repeat(7, 16fr); 
	}
	.settings_table {
		margin: 6px;
	}
	.settings_wrap {
		display: grid;
		grid-template-rows: 1fr;
		grid-template-columns: repeat(2, 1fr);
		color: #113355;
		font-size: 1.6em;
	}
	.settings_table .label_left {
		width: 15em;
		display: block;
	}
	.settings_table input[type="text"], .settings_table select  {
		display: block;
		background-color: #113355;
		border-style: solid;
		border-color: #4499cc;
		border-width: 2px;
		padding: 0.2em;
		color: #fefefe;
		width: 14em;
		font-size: 1em;
	}
</style>
<script type="text/javascript">
	'use_strict';
	
	var steps = 80;
	var step_size = 1;
	var init_temp = -45;
	//----------------------//
	var wd = { meta: {}, data: [] };
	var tempcostWrapElem;
	var settingsWrapElem;
	var settingsColWrapElem = [];
	var settingsColMainElem = [];
	var compColSwitchCheckbox;
	var compColSwitchLabel;
	var settingsElems = [ {}, {} ];
	var tempcostElems = [];
	var tempcostElemH = [];
	var mainPartElem;
	var docHeaderElem;
	var docBottomElem;
	
	var lang = 'ru';
	var labels = {
		settings: {
			en: 'Settings',
			ru: 'Настройки',
		},
		save: {
			en: 'Save',
			ru: 'Сохранить',
		},
		width: {
			en: 'width, m',
			ru: 'ширина, м',
		},
		length: {
			en: 'length, m',
			ru: 'длина, м',
		},
		height: {
			en: 'height, m',
			ru: 'высота, м',
		},
		baseConsumption: {
			en: 'base consumption, rub',
			ru: 'базовое потребление, руб',
		},
		exhaustPart: {
			en: 'part of base consumption unsaved',
			ru: 'процент несохраняемого базового потребления (водонагреватели, отопление других объектов)',
		},
		commonInfo: {
			en: 'Common Info',
			ru: 'Общая Информация',
		},
		commonInfo: {
			en: 'Common Info',
			ru: 'Общая Информация',
		},
		wall: {
			en: 'Wall',
			ru: 'Стена',
		},
		wallWidth: {
			en: 'wall width',
			ru: 'ширина стены',
		},
		material: {
			en: 'material',
			ru: 'материал',
		},
		aerocrete_glue: {
			en: 'aerocrete + glue',
			ru: 'газоблок + клей',
		},
		aerocrete_cement: {
			en: 'aerocrete + cement',
			ru: 'газоблок + цемент',
		},
		brick: {
			en: 'brick',
			ru: 'кирпич',
		},
		ferroconcrete: {
			en: 'ferro-concrete',
			ru: 'железобетон',
		},
		slag_concrete: {
			en: 'slag concrete',
			ru: 'шлакоблок',
		},
		pine: {
			en: 'pine',
			ru: 'сосна',
		},
		oak: {
			en: 'oak',
			ru: 'дуб',
		},
		insolation: {
			en: 'insolation width, m',
			ru: 'ширина изоляции, м',
		},
		powerCost: {
			en: 'power cost, rub/kW*h',
			ru: 'цена электроэнергии, руб/кВт*ч',
		},
		tempMaintained: {
			en: 'temperature maintained, C',
			ru: 'поддерживаемая температура, C',
		},
		tempUpperLimit: {
			en: 'upper limit of temperature, C',
			ru: 'верхний предел температуры, C',
		},
		addComparision: {
			en: 'add comparision',
			ru: 'добавить сравнение',
		},
		rub: {
			en: 'Rub',
			ru: 'Руб',
		},
		celsius: {
			en: '°C',
			ru: '°C',
		},
		watt: {
			en: 'W',
			ru: 'Вт',
		},
		kilo: {
			en: 'k',
			ru: 'к',
		},
	};
	var p_main = 0;
	var p_comp = 1;
	var par = [
		{
			enabled: true,
			always: true,
			k: 0.42, 
			a: 6,
			b: 7,
			h: 2.5,
			t1: 20,
			t1u: 24,
			l: 0.25,
			ka: 0.15,
			insl: 0.2,
			k2: 0.7,
			l2: 0.2,
			tw: false,
			k_oth: 0.25,
			base: 2000,
			ex: 50,
			cost: 2,
		},
		{
			enabled: false,
			always: false,
			k: 0.42, 
			a: 6,
			b: 7,
			h: 2.5,
			t1: 20,
			t1u: 24,
			l: 0.25,
			ka: 0.15,
			insl: 0.2,
			k2: 0.7,
			l2: 0.2,
			tw: false,
			k_oth: 0.25,
			base: 2000,
			ex: 50,
			cost: 2,
		},
	];
	var limits = {
		ex: { lower: 0, upper: 100 },
	};
	function round( number, precision ) {
		return Math.round( number * Math.pow(10, precision) ) / Math.pow(10, precision);
	}
	function getPowerByTemp( t0, col ) {
		var base_power = (par[col].base / (720 * par[col].cost))*(1-par[col].ex/100);
		var power;
		var t1 = ( par[col].t1 >= t0 ) ? par[col].t1 : par[col].t1u; 
		var dt = t1 - t0;
		var s = (par[col].a + par[col].b) * 2 * par[col].h;
		if ( par[col].tw ) {
			power = dt / ( par[col].l / (par[col].k * s) + par[col].insl / (par[col].ka * s)
						+ par[col].l2 / (par[col].k2 * s) ) / 1000;
		} else {
			power = par[col].k * s * dt / par[col].l / 1000;
		}
		var s_oth = par[col].a * par[col].b * 2;
		var power_oth = par[col].k_oth * s_oth * dt / 1000;
		var gen_power = power + power_oth - base_power;
		return ( gen_power < 0 && dt >= 0 ) ? 0 : gen_power
	}
	function getCostByPower( power, col, timeSpan ) {
		if ( timeSpan === undefined ) timeSpan = 720;
		power = Math.abs( power );
		var cost = power * par[col].cost * timeSpan + par[col].base;
		return (cost > par[col].base) ? cost : par[col].base;
	}
	function getCostByTemp( t0, col, timeSpan ) {
		if ( timeSpan === undefined ) timeSpan = 720;
		var power = getPowerByTemp( t0, col );
		var cost = power * par[col].cost * timeSpan + par[col].base;
		return (cost > par[col].base) ? cost : par[col].base;
	}
	function getTempStr( temp ) {
		var sign = ( +temp > 0 ) ? '+' : '';
		return sign + temp + labels.celsius[lang];
	}
	function numFormat( num, precision ) {
		if ( precision === undefined ) precision = 2;
		var numSuffix = [ '', 'K', 'M', 'G', 'T' ];
		var degree_thr = 5;
		var degree = degree_thr - 1;
		for ( var i=0; i < degree_thr; i++ )
			if ( num < Math.pow(1000, i+1) ) {
				degree = i;
				break;
			}
		var numBase = num / Math.pow(1000, degree);
		var digits = 0;
		for ( var i=1; i < 20; i++ )
			if ( numBase < Math.pow(10, i) ) {
				digits = i;
				break;
			}
		var rnd_precision = precision - digits;
		var num = round( numBase, rnd_precision );
		
		return '' + num + numSuffix[ degree ];
	}
	/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
	function switchGroupDisplay( col ) {
		var hidden_state = par[col].tw;
		var containerElem = settingsColMainElem[col].querySelectorAll('fieldset');
		containerElem = containerElem[2];
		var divElems = containerElem.querySelectorAll('div');
		for ( var i=0; i < divElems.length; i++ ) {
			divElems[i].hidden = hidden_state
		};
		par[col].tw = !hidden_state;
	}
	/*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/
	function switchCompCol( col ) {
		if ( !par[col].enabled )
			settingsColWrapElem[col].appendChild( settingsColMainElem[col] );
		else
			settingsColMainElem[col] = settingsColWrapElem[col].removeChild( 
				settingsColMainElem[col] );
		par[col].enabled = !par[col].enabled;
	}
	var addElem = (function() {
		var type_elem = { text: 'input', checkbox: 'input', select: 'select', option: 'option' };
		var label_pos = { text: 'left', checkbox: 'right', select: 'left' };
		var spec_prop = [ 'type', 'label' ];
		return function( parameters, id, addtoElem ) {
			var type = parameters.type;
			var labelElem;
			var inputElem = document.createElement( type_elem[type] );
			if ( type_elem[type] != type ) inputElem.type = type;
			if ( id !== null ) inputElem.id = type + '_' + id;
			for ( i in parameters ) {
				if ( spec_prop.indexOf( i ) > -1 ) continue;
				inputElem[i] = parameters[i];
			}
			if ( label_pos[ type ] ) {
				labelElem = document.createElement('label');
				labelElem.htmlFor = inputElem.id;
				labelElem.className = 'label_'+label_pos[ type ];
				labelElem.textContent = parameters.label;
			}
			if ( label_pos[ type ] == 'left' ) {
				addtoElem.appendChild( labelElem );
			}
			addtoElem.appendChild( inputElem );
			if ( label_pos[ type ] == 'right' ) {
				addtoElem.appendChild( labelElem );
			}
			return inputElem;
		};
	})();
	function assignElemVal( mode ) {
		for ( var c in settingsElems ) {
			for ( var i in settingsElems[c] ) {
				var valtoAssign=null;
				if ( settingsElems[c][i].tagName.toLowerCase() == 'input' ) {
					if ( settingsElems[c][i].type.toLowerCase() == 'text' ) {
						if ( mode != 'store' ) settingsElems[c][i].value = par[c][i];
						else {
							valtoAssign = +settingsElems[c][i].value;
							if ( limits.hasOwnProperty(i) )
								if ( limits[i].lower > valtoAssign || limits[i].upper < valtoAssign ) {
									settingsElems[c][i].value = par[c][i];
									continue;
								}
						}
					} else if ( settingsElems[c][i].type.toLowerCase() == 'checkbox' ) {
						if ( mode != 'store' ) settingsElems[c][i].checked = par[c][i];
						else valtoAssign = settingsElems[c][i].checked;
					}
				} else if ( settingsElems[c][i].tagName.toLowerCase() == 'select' ) {
					if ( mode != 'store' ) {
						var index = -1;
						for ( var j=0; j < settingsElems[c][i].length; j++ )
							if ( +settingsElems[c][i][j].value == par[c][i] ) {
								index = j;
								break;
							}
						settingsElems[c][i].selectedIndex = index;
					} else {
						var index = settingsElems[c][i].selectedIndex;
						valtoAssign = +settingsElems[c][i][index].value;
					}
				}
				if ( mode == 'store' ) {
					par[c][i] = valtoAssign;
				}
			}
		}
	}
	function formSettings( col ) {
		var elemsData = {
			common: {
				head: { 
					type: 'plain_text', label: labels.commonInfo[lang], 
				},
				main: {
					a: { type: 'text', label: labels.length[lang] },
					b: { type: 'text', label: labels.width[lang] },
					h: { type: 'text', label: labels.height[lang] },
					t1: { type: 'text', label: labels.tempMaintained[lang] },
					t1u: { type: 'text', label: labels.tempUpperLimit[lang] },
					cost: { type: 'text', label: labels.powerCost[lang] },
					base: { type: 'text', label: labels.baseConsumption[lang] },
					ex: { type: 'text', label: labels.exhaustPart[lang] },
				},
			},
			wall: {
				head: {
					type: 'plain_text', label: labels.wall[lang] + ' 1',
				},
				main: {
					l: { type: 'text', label: labels.wallWidth[lang] },
					k: { type: 'select', label: labels.material[lang], includes: [
						{ type: 'option', value: 0.25, textContent: labels.aerocrete_glue[lang] },
						{ type: 'option', value: 0.42, textContent: labels.aerocrete_cement[lang] },
						{ type: 'option', value: 0.7, textContent: labels.brick[lang] },
						{ type: 'option', value: 2, textContent: labels.ferroconcrete[lang] },
						{ type: 'option', value: 0.55, textContent: labels.slag_concrete[lang] },
						{ type: 'option', value: 0.18, textContent: labels.pine[lang] },
						{ type: 'option', value: 0.23, textContent: labels.oak[lang] },
					] },
				},
			},
			wall_2: {
				head: {
					type: 'checkbox', label: labels.wall[lang] + ' 2', name: 'tw'
				},
				main: {
					options: { off: !par[col].tw },
					insl: { type: 'text', label: labels.insolation[lang] },
				},
			},
		};
		elemsData.wall_2.main.l2 = elemsData.wall.main.l;
		elemsData.wall_2.main.k2 = elemsData.wall.main.k;
		
		var switchData = { type: 'checkbox', label: labels.addComparision[lang] };
		settingsElems[col]['enabled'] = addElem( switchData, 'switch_col_'+col, settingsColWrapElem[col] );
		if ( par[col].always ) settingsElems[col]['enabled'].disabled = true;
		else settingsElems[col]['enabled'].onclick = switchCompCol.bind(null,col);
		
		settingsColMainElem[col] = document.createElement('div');
		var mainContainerElem = document.createElement('form');
		for ( var i in elemsData ) {
			var off = false;
			var groupContainerElem = document.createElement('fieldset');
			var descrElem = document.createElement('legend');
			if ( elemsData[i].head.type == 'plain_text' ) {
				descrElem.textContent = elemsData[i].head.label;
			} else if ( elemsData[i].head.type == 'checkbox' ) {
				var tempElem = addElem( elemsData[i].head, i+'_'+col, descrElem );
				if ( elemsData[i].head.hasOwnProperty('name') ) {
					settingsElems[col][ elemsData[i].head.name ] = tempElem;
				}
			}
			groupContainerElem.appendChild( descrElem );
			for ( var j in elemsData[i].main ) {
				if ( j == 'options' ) {
					if ( elemsData[i].main.options.hasOwnProperty('off') )
						off = elemsData[i].main.options.off;
					continue;
				}
				var elemContainer = document.createElement('div');
				var currentElem = elemsData[i].main[j];
				settingsElems[col][j] = addElem( currentElem, j+'_'+col, elemContainer );
				if ( currentElem.type == 'select' )
					for ( var k=0; k < currentElem.includes.length; k++ ) {
						addElem( currentElem.includes[k], null, settingsElems[col][j] );
					}
				if ( off ) elemContainer.hidden = true;
				groupContainerElem.appendChild( elemContainer );
			}
			mainContainerElem.appendChild( groupContainerElem );
		}
		assignElemVal();
		settingsElems[col].tw.onclick = switchGroupDisplay.bind(null,col);
		settingsColMainElem[col].appendChild( mainContainerElem );
		if ( par[col].enabled ) {
			settingsColWrapElem[col].appendChild( settingsColMainElem[col] );
		}
	}
	function applySettings() {
		assignElemVal( 'store' );
		refreshForecast();
	}
	var switchSettingsState = (function() {
		var settingsEnabled = false;
		return function() {
			if ( !settingsEnabled ) {
				mainPartElem.innerHTML = "";
				this.textContent = labels.save[lang]+' '+labels.settings[lang];
				mainPartElem.appendChild( settingsWrapElem );
			} else {
				mainPartElem.innerHTML = "";
				applySettings();
				this.textContent = labels.settings[lang];
				mainPartElem.appendChild( tempcostWrapElem );
			}
			settingsEnabled = !settingsEnabled;
		};
	})();
	function getOutputString( temp ) {
		var power = getPowerByTemp( temp, p_main );
		var cost_month_str = '' + round(getCostByPower( power, p_main ), -2);
		var power_str = '' + round( power, 1 );
		if ( par[p_comp].enabled ) {
			power = getPowerByTemp( temp, p_comp );
			cost_month_str += ' / ' + round(getCostByPower( power, p_comp ), -2);
			power_str += ' / ' + round( power, 1);
		}
		return { power: power_str, cost_month: cost_month_str };
	}
	function refreshForecast() {
		for ( var i=0; i < wd.data.length; i++ ) {
			var temp = wd.data[i].temp;
			var outputStr = getOutputString( temp );
			tempcostElems[i].cost_month.textContent = outputStr.cost_month + ' ' + labels.rub[lang];
			tempcostElems[i].power.textContent = outputStr.power + ' ' + labels.kilo[lang] + labels.watt[lang];
		}
	}
	function printOutForecast() {
		function printOutHeader( temp ) {
			var i = tempcostElemH.push( {} ) - 1;
			tempcostElemH[i].cell = document.createElement('div');
			tempcostElemH[i].rnd_temp = document.createElement('div');
			tempcostElemH[i].rnd_temp.className = 'tempcost_rnd_temp';
			tempcostElemH[i].rnd_temp.textContent = getTempStr( temp );
			tempcostElemH[i].cell.className = 'tempcost_head';
			tempcostElemH[i].cell.appendChild( tempcostElemH[i].rnd_temp );
			tempcostWrapElem.appendChild( tempcostElemH[i].cell );
		}
		var prev_rnd_temp = -274;
		mainPartElem.innerHTML = "";
		tempcostWrapElem = document.createElement('div');
		tempcostWrapElem.className = 'tempcost_table';
		for ( var i=0; i < wd.data.length; i++ ) {
			var rnd_temp = wd.data[i].rnd_temp;
			var temp = wd.data[i].temp;
			var sign = ( temp > 0 ) ? '+' : '';
			var tempStr = getTempStr( temp );
			var outputStr = getOutputString( temp );
			if ( rnd_temp != prev_rnd_temp ) {
				var headerData = ( prev_rnd_temp > -274 ) ? [ temp, rnd_temp ] : [ rnd_temp ]; 
				for ( var j=0; j<headerData.length; j++ ) {
					printOutHeader( headerData[j] )
				}
			}
			prev_rnd_temp = rnd_temp;
			tempcostElems[i] = {};
			tempcostElems[i].cell = document.createElement('div');
			tempcostElems[i].temp = document.createElement('div');
			tempcostElems[i].cost_month = document.createElement('div');
			tempcostElems[i].power = document.createElement('div');
			tempcostElems[i].temp.className = 'tempcost_temp';
			tempcostElems[i].temp.textContent = tempStr;
			tempcostElems[i].cost_month.className = 'tempcost_cost';
			tempcostElems[i].cost_month.textContent = outputStr.cost_month + ' ' + labels.rub[lang];
			tempcostElems[i].power.className = 'tempcost_power';
			tempcostElems[i].power.textContent = outputStr.power + ' ' + labels.kilo[lang] + labels.watt[lang];
			tempcostElems[i].cell.className = 'tempcost_cell';
			tempcostElems[i].cell.appendChild( tempcostElems[i].temp );
			tempcostElems[i].cell.appendChild( tempcostElems[i].cost_month );
			tempcostElems[i].cell.appendChild( tempcostElems[i].power );
			tempcostWrapElem.appendChild( tempcostElems[i].cell );
		}
		printOutHeader( wd.data[ wd.data.length - 1 ].temp + 1 );
		mainPartElem.appendChild( tempcostWrapElem );
	}
	window.onload = function() {
		var selectors = {
			docHeaderElem: '#header',
			mainPartElem: '#main_part',
			docBottomElem: '#footer'
		};
		for ( var i in selectors ) {
			window[i] = document.querySelectorAll( selectors[i] );
			if ( window[i].length != 1 ) throw new Error('error!');
			window[i] = window[i][0];
		}
		
		settingsWrapElem = document.createElement('div');
		settingsColWrapElem[p_main] = document.createElement('div');
		settingsColWrapElem[p_comp] = document.createElement('div');
		settingsWrapElem.className = 'settings_wrap';
		settingsColWrapElem[p_main].className = 'settings_table';
		settingsColWrapElem[p_comp].className = 'settings_table';
		settingsWrapElem.appendChild( settingsColWrapElem[p_main] );
		settingsWrapElem.appendChild( settingsColWrapElem[p_comp] );
		formSettings( p_main );
		formSettings( p_comp );
		
		docBottomElem.textContent = labels.settings[lang];
		docBottomElem.onclick = switchSettingsState;
		
		for ( var i=0; i<steps; i++ ) {
			var temp = init_temp + i*step_size;
			wd.data[i] = {};
			wd.data[i].temp = temp;
			var rnd_temp = Math.floor(wd.data[i].temp / 5) * 5;
			var sign = ( rnd_temp > 0 ) ? '+' : '';
			wd.data[i].rnd_temp = rnd_temp;
		}
		
		printOutForecast();
	};
</script>
</head>
<body>
<div id="page_content">
	<div id="header">
		Стоимость Погоды
	</div>
	<div id="main_part">
	</div>
	<div id="footer">
		Стоимость Погоды
	</div>
<div>
</div>
</body>
</html>